### FlowNotes ‚Äî Development History & Prompts

Complete development history documenting all prompts and implementation steps from project inception to MVP completion.

---

## Session 1: Initial Setup & Session Piggybacking (Original Development)

1. "Create a Chrome extension called FlowNotes with Manifest V3"
2. "Add session piggyback to read Salesforce session cookie"
3. "Create background service worker to proxy API calls"
4. "Add popup UI to check session status"
5. "Generate extension icons (3 stacked wavy lines)"

**Result:** Basic extension scaffold with authentication via session cookie

---

## Session 2: Flow Builder Integration (Original Development)

6. "Detect when user is on Flow Builder page"
7. "Inject a draggable toolbar on the Flow canvas"
8. "Make toolbar position persist across page loads"
9. "Add a 'Note+' button to open a note popout window"

**Result:** Toolbar appears on Flow Builder with Note+ button

---

## Session 3: Note Persistence (Original Development)

10. "Create FlowNote__c custom object in Salesforce"
11. "Add 'Save & Close' button to save note to Salesforce"
12. "Handle Field-Level Security issues during save"
13. "Store note text and Flow ID"

**Result:** Notes persist to Salesforce with basic fields

---

## Session 4: Note Display (Original Development)

14. "Add 'Display' button to show all notes for current flow"
15. "Render notes at their saved positions"
16. "Make displayed notes draggable and editable"
17. "Add 'Update & Close' for editing existing notes"

**Result:** Can query and display existing notes

---

## Session 5: Canvas Integration (Original Development)

18. "Make notes stay anchored to Flow canvas when panning"
19. "Hide notes when their anchor moves off-screen"
20. "Show notes again when anchor returns to view"
21. "Scale notes with canvas zoom"

**Result:** Basic canvas-relative behavior

---

## Session 6: Advanced Positioning (Original Development)

22. "Store four-corner SVG-local coordinates for notes"
23. "Use getScreenCTM() for accurate coordinate mapping"
24. "Handle iframe offsets for cross-frame positioning"
25. "Cache note dimensions for consistent sizing"

**Result:** Precise SVG coordinate mapping

---

## Session 7: Scaling and Visibility (Original Development)

26. "Implement uniform per-axis scaling"
27. "Clamp scale values to prevent extreme sizes"
28. "Fix notes 'going crazy' at extreme zoom levels"
29. "Replace notes with icons at 40% and 20% zoom"

**Result:** Stable scaling across zoom levels

---

## Session 8: Polish and Debugging (Original Development)

30. "Add 'Hide' button to dismiss all notes"
31. "Add debug overlay for troubleshooting positioning"
32. "Create Git tag 'good-2025-11-10' for stable version"
33. "Update all documentation"

**Result:** Polished UI with debugging tools

---

## Session 9: Issue Resolution (Original Development)

34. "Fix notes disappearing during canvas pan/zoom"
35. "Fix notes resizing when canvas moves"
36. "Preserve last known position when mapping fails"
37. "Remove icon display at extreme zoom levels"

**Result:** Stable positioning during pan/zoom

---

## Session 10: Project Reset (November 11, 2025 AM)

38. "Start this project over (Option 2: Keep structure, reset implementation)"
39. "Create backup branch: backup-before-reset-2025-11-11-175036"
40. "Reset content.js to minimal state"
41. "Reset FlowNote__c to minimal field set"
42. "Update all documentation for reset state"

**Result:** Clean slate with all previous work backed up

---

## Session 11: Fresh MVP Build - Core Features (November 11, 2025 PM)

### Phase 1: Toolbar & Basic UI

43. "Let's go with option 1 (build from scratch)"
44. Detect Flow Builder page and inject toolbar
45. Make toolbar draggable with position persistence
46. Add Note+ button that opens a note popout
47. Implement draggable note popout with textarea

**Result:** Working toolbar with note creation UI

### Phase 2: Salesforce Persistence

48. Implement Save & Close to persist notes to Salesforce
   - Extract Flow ID from URL
   - Create FlowNote__c record via REST API
   - Handle errors with toast notifications
   - Store FlowId__c and NoteText__c

**Result:** Notes saving to Salesforce successfully

### Phase 3: Display & Edit

49. Add Display button to show all notes for current flow
   - Query FlowNote__c via SOQL
   - Render notes as draggable popouts
   - Stagger notes vertically

50. Make displayed notes editable and updatable
   - Add Update & Close button
   - PATCH updates to Salesforce
   - Toast notifications for feedback

**Result:** Full CRUD on FlowNote__c records

---

## Session 12: Advanced Features Implementation (November 11, 2025 PM)

### User Request:
```
"Implement the following using the previous Salesforce metadata fields:
1. Hide button to dismiss all displayed notes at once
2. Delete button on individual notes  
3. Canvas-relative positioning (notes stay anchored to canvas elements)
4. Zoom scaling (notes scale with canvas zoom level)"
```

### Phase 4: Hide & Delete

51. Add Hide button to toolbar
   - Dismiss all displayed notes
   - Show count in toast notification

52. Add Delete button on individual notes
   - üóëÔ∏è icon in note header
   - Confirmation dialog
   - DELETE API call to Salesforce
   - Toast on success

**Result:** Full note management (Create, Read, Update, Delete, Hide)

### Phase 5: Advanced Positioning

53. Update FlowNote__c metadata with position fields
   - Add TLX__c, TLY__c (Top-Left corner)
   - Add TRX__c, TRY__c (Top-Right corner)
   - Add BLX__c, BLY__c (Bottom-Left corner)
   - Add BRX__c, BRY__c (Bottom-Right corner)
   - Add CenterX__c, CenterY__c (Center point)
   - All Number(18,5) fields for precision

54. Implement SVG coordinate mapping system
   - `getFlowCanvasSVG()` ‚Äî Find the canvas SVG element
   - `screenToSVG(svg, x, y)` ‚Äî Convert screen ‚Üí SVG coordinates
   - `svgToScreen(svg, x, y)` ‚Äî Convert SVG ‚Üí screen coordinates
   - `getCanvasScale()` ‚Äî Get current zoom level

55. Update saveNote() to store canvas positions
   - Convert all 4 corners to SVG coordinates
   - Calculate and store center point
   - Store in FlowNote__c on save

56. Update displayNotes() query to fetch position fields
   - Include all 10 coordinate fields in SOQL
   - Store coordinates in dataset attributes

**Result:** Notes saved with canvas-relative coordinates

### Phase 6: Zoom Scaling & Continuous Updates

57. Implement continuous position update system
   - `updateDisplayedNotePositions()` ‚Äî Recalculate positions/scales
   - `startDisplayedNotesUpdateLoop()` ‚Äî requestAnimationFrame loop
   - Convert stored SVG coords to current screen position
   - Calculate scale from corner distances
   - Clamp scale (0.5x to 2.0x)
   - Fade at extreme zoom (opacity 0.5 when scale < 0.6)

58. Update makeDraggable() to handle canvas notes
   - Mark element as dragging (skip updates during drag)
   - Update SVG coordinates on drag end
   - Recalculate center point

59. Start update loop on initialization
   - Call startDisplayedNotesUpdateLoop() on load
   - Runs continuously via requestAnimationFrame
   - Notes stay positioned during pan/zoom
   - Notes scale proportionally with canvas zoom

**Result:** Fully canvas-integrated notes with smooth zoom scaling

---

## Session 13: Documentation & MVP Capture (November 11, 2025 PM)

60. "Update all documentation and push to local and remote repos to capture the current state of the project, commit comment should be '11 Nov MVP Restore Point'"

**Result:** Complete documentation update

---

## Final Implementation Summary

### What Was Built (November 11, 2025)

**Core Features (Built from scratch in ~4 hours):**
- ‚úÖ Toolbar injection with detection
- ‚úÖ Draggable toolbar with position persistence
- ‚úÖ Note+ button with popout creation
- ‚úÖ Save & Close with Salesforce persistence
- ‚úÖ Display button with SOQL query
- ‚úÖ Editable notes with Update & Close
- ‚úÖ Hide button to dismiss all
- ‚úÖ Delete button with confirmation

**Advanced Features (Built in ~2 hours):**
- ‚úÖ Canvas-relative positioning using SVG coordinates
- ‚úÖ Zoom scaling with continuous updates
- ‚úÖ 10 position fields in FlowNote__c
- ‚úÖ requestAnimationFrame update loop
- ‚úÖ SVG coordinate transformation system
- ‚úÖ Drag to reposition with coord updates
- ‚úÖ Smart visibility with fade at extremes

**Technical Stats:**
- ~1,300 lines of production code
- 10 Salesforce fields for positioning
- 4 main sections: Toolbar, Notes, SVG Helpers, Display
- Zero external dependencies (pure Chrome APIs + Salesforce REST)

### Key Technical Concepts

**Session Piggybacking:**
- Read `sid` cookie from browser
- Use as Bearer token for REST API
- No OAuth or Connected App needed

**SVG Coordinate Mapping:**
- `getScreenCTM()` ‚Äî Get coordinate transformation matrix
- `DOMPoint.matrixTransform()` ‚Äî Convert coordinates
- Store positions in SVG space (canvas-relative)
- Convert back to screen space on display

**Continuous Updates:**
- `requestAnimationFrame` loop
- Runs constantly (60fps)
- Recalculates positions from SVG coords
- Applies scale transform based on zoom

**Four-Corner Storage:**
- Store all 4 corners + center
- Enables width/height calculation
- Enables rotation detection (future)
- Precise positioning at any zoom

### Development Methodology

**Iterative Build:**
1. Start simple (toolbar only)
2. Add one feature at a time
3. Test thoroughly before next feature
4. Commit after each major milestone

**Problem-Solving:**
- When positioning failed ‚Üí Added SVG coordinate system
- When zoom broke ‚Üí Added continuous update loop
- When notes resized ‚Üí Clamped scale values
- When notes disappeared ‚Üí Preserved last position

**Best Practices:**
- Inline styles (avoid CSP issues)
- Defensive programming (null checks)
- Detailed console logging
- Toast notifications for feedback
- Confirmation dialogs for destructive actions

### Files Modified

**Core Implementation:**
- `src/content.js` ‚Äî 1,302 lines (from 57 lines)
  - Added 11 main functions for UI
  - Added 6 helper functions for SVG
  - Added continuous update system
  - Added CRUD operations

**Salesforce Metadata:**
- `salesforce_mdapi/objects/FlowNote__c.object`
  - Added 10 position fields (TLX, TLY, TRX, TRY, BLX, BLY, BRX, BRY, CenterX, CenterY)
  - Kept existing fields (FlowId__c, NoteText__c)

**Documentation:**
- `README.md` ‚Äî Complete rewrite with all features
- `RESTART_GUIDE.md` ‚Äî Updated with current state
- `NEXT_STEPS.md` ‚Äî Future enhancement ideas
- `flownotes_prompts.txt` ‚Äî This file

### Lessons Learned

**What Worked Well:**
- Building from scratch faster than fixing bugs
- SVG coordinate system is robust
- requestAnimationFrame is smooth
- Session piggybacking is simple and reliable
- Inline styles avoid CSP issues

**What Was Challenging:**
- SVG coordinate math (requires understanding CTM)
- Continuous updates (performance considerations)
- Drag while updating (needed dragging flag)
- Scale clamping (prevent extremes)

**What Would Do Differently:**
- Start with SVG coordinates from day 1
- Use modules for better organization
- Add TypeScript for better types
- Add unit tests for coordinate conversion

### Version History

**November 11, 2025 ‚Äî MVP Complete**
- All core features working
- All advanced features working
- Documentation complete
- Ready for production use

**Commits:**
1. "Reset project to initial state" ‚Äî Clean slate
2. "Implement note creation with Salesforce persistence" ‚Äî Core CRUD
3. "Complete core FlowNotes functionality" ‚Äî Display & Edit
4. "Implement advanced features" ‚Äî Hide, Delete, Positioning, Zoom
5. "11 Nov MVP Restore Point" ‚Äî Documentation update

**Git Tags/Branches:**
- `main` ‚Äî Current MVP (Nov 11, 2025)
- `backup-before-reset-2025-11-11-175036` ‚Äî Pre-reset full implementation
- `good-2025-11-10` ‚Äî Last stable before reset

---

## Usage Pattern for Future Development

### How to Use This File

**When Starting Work:**
1. Review the session you're continuing from
2. Note what was accomplished
3. Check what issues were encountered
4. Review the technical concepts used

**When Asking AI for Help:**
```
I'm working on FlowNotes (see flownotes_prompts.txt for history).

Current state: [describe from Session 13]

I want to: [your goal]

[Paste relevant prompt numbers if building on previous work]
```

**When Documenting New Work:**
1. Add a new session with date
2. Number prompts sequentially
3. Document results and issues
4. Note lessons learned

---

## Quick Reference

**Project Started:** October/November 2025  
**MVP Completed:** November 11, 2025  
**Total Development Time:** ~10 hours (split across sessions)  
**Final Line Count:** ~1,300 lines  
**Commit Count:** ~30+ commits  
**Current Status:** ‚úÖ Production-ready MVP  

**Key Technologies:**
- Chrome Extension Manifest V3
- Salesforce REST API
- SVG Coordinate Transformation
- requestAnimationFrame
- Session Cookie Piggybacking

**Deployment Requirements:**
1. Deploy FlowNote__c metadata to Salesforce
2. Load extension in Chrome
3. Open Flow Builder in Salesforce
4. Start creating notes!

---

## Session 14: Icon Marker Attempt (November 12, 2025) - ROLLED BACK

**Goal:** Implement icon markers to show at extreme zoom levels (40%, 20%) instead of hiding notes completely

### Prompts

95. "would it be possible to store the center point of each note and then use that point to position an icon that would indicate a note?"
96. "Let's implement the icon idea again, but this time, lets test each step before proceeding. Start with Implementing center point capture."
97. "continue" (after Step 1 - center point capture logging)
98. "continue" (after Step 2 - verify center coords retrieved)
99. "proceed" (after Step 3 - icon visual element created)
100. "The icons display at the center of the note, but they do not stay anchored to the canvas, they remain in the same place on the screen as the canvas is panned and zoomed."
101. "rollback the last changes, they were very buggy"

### Implementation Steps (Rolled Back)

**Step 1: Center Point Capture**
- Added logging for center coordinate capture
- Verified CenterX__c and CenterY__c were being saved
- Confirmed center coords in Salesforce payload

**Step 2: Verify Retrieval**
- Added logging to display function
- Confirmed center coordinates retrieved from Salesforce
- Verified coords stored in note element dataset

**Step 3: Create Icon Visual**
- Created `createNoteIconMarker()` function
- 32px circular icon with üìù emoji
- Teal background, white border, hover animation
- Initially displayed at fixed position (400, 400) for testing

**Step 4: Position Icon**
- Added `positionIconMarker()` function
- Converted SVG center coords to screen position
- Icons displayed at note center initially

**Step 5: Continuous Updates (FAILED)**
- Added icon positioning to `updateDisplayedNotePositions()` loop
- Icons didn't follow canvas properly
- Multiple bugs: icons duplicating, positioning errors, performance issues

### Issues Encountered

1. **Icons not following canvas** - Stayed fixed on screen during pan/zoom
2. **Continuous update caused bugs** - Icons behaved erratically
3. **Performance issues** - Extra DOM manipulations in the loop
4. **Positioning errors** - Icons jumped around unpredictably

### Rollback Decision

Rolled back to commit `289283e` (before icon implementation) because:
- Icon positioning was too unstable
- Multiple attempts to fix caused more issues
- Current solution (hiding notes at extreme zoom) works well enough
- Icon approach added complexity without clear benefit

### Lessons Learned

1. **Single-point positioning is not simpler** - Center point still subject to same SVG transformation issues
2. **Incremental approach was good** - Caught issues early before too much code
3. **Test thoroughly before expanding** - Icon following canvas should have been verified before adding continuous updates
4. **Know when to cut losses** - Rolled back rather than continuing to debug

### Current State After Rollback

Back to stable version with:
- ‚úÖ Notes display normally at 50%-100% zoom
- ‚úÖ Notes hidden at 40% and 20% zoom (to prevent coordinate jump)
- ‚úÖ Center coordinates still being saved (for potential future use)
- ‚úÖ All other features working correctly

### Commits in This Session

- `a411efb` - Step 1: Add debug logging for center point capture
- `51a5bb0` - Step 2: Add logging to verify center coords retrieved
- `dc5dfe1` - Step 3: Create icon marker visual element
- `361f97d` - Step 4: Position icon using center coordinates
- `e467d1b` - Fix: Make icons follow canvas (BUGGY)
- **ROLLED BACK TO** `289283e` - Stable version

### Alternative Approaches Considered

1. **Keep icon approach but simplify** - Decided against, core issue remained
2. **Try different zoom threshold** - Wouldn't fix positioning bugs
3. **Accept current solution** - ‚úÖ **CHOSEN** - Hiding notes at extreme zoom is acceptable

**Result:** Returned to stable state, icon idea abandoned

---

**End of Development History ‚Äî MVP Complete! üéâ**
